#!/bin/bash
# vimg - View image on local machine via WezTerm
#
# Usage: vimg <image_file>
#
# This script sends an OSC sequence to WezTerm, which triggers
# scp to copy the image and open it locally.
#
# Requirements:
# - WezTerm with user-var-changed handler configured
# - SSH Host name in ~/.ssh/config must match hostname (or set SSH_HOST below)

# Use SSH_HOST env var if set, otherwise use hostname
HOST="${SSH_HOST:-$(hostname)}"

if [ -z "$1" ]; then
    echo "Usage: vimg <image_file>"
    exit 1
fi

if [ ! -f "$1" ]; then
    echo "Error: File not found: $1"
    exit 1
fi

FILE=$(realpath "$1")
PAYLOAD="$(echo -n "$HOST:$FILE" | base64)"

if [ -n "$TMUX" ]; then
    # tmux requires wrapping OSC sequences
    printf '\ePtmux;\e\e]1337;SetUserVar=view-image=%s\a\e\\' "$PAYLOAD"
else
    printf '\e]1337;SetUserVar=view-image=%s\a' "$PAYLOAD"
fi
echo "Opening: $FILE"
